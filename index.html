<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Block Game</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:sans-serif;}
body{
    background:linear-gradient(135deg,#00665e,#00665e);
    display:flex;
    justify-content:center;
    align-items:center;
    min-height:100vh;
}
.container{width:100%;max-width:500px;text-align:center;}
.menu,.game{
    background:white;
    padding:20px;
    border-radius:20px;
    box-shadow:0 10px 30px rgba(0,0,0,0.15);
}
.game{display:none;}

.board{
    display:grid;
    grid-template-columns:repeat(8,1fr);
    gap:2px;
    margin:15px 0;
}

.cell{
    width:100%;
    padding-top:100%;
    position:relative;
    background:#ecf0f1;
    border-radius:0px;
    transition:none:

}
.clear-highlight{
    box-shadow:0 0 15px 5px #ffeaa7 inset;
    animation:flash 0.3s ease alternate 2;
}

@keyframes flash{
    from{opacity:1;}
    to{opacity:0.4;}
}


.cell.preview-valid{background:#81ecec;}
.cell.preview-invalid{background:#ff7675;}

.blocks{display:flex;justify-content:space-around;}
.block{display:grid;gap:3px;touch-action:none;cursor:pointer;}
.block div{
    width:24px;height:24px;
    border-radius:0px;
}

.score{margin:8px 0;font-size:18px;}
.combo{color:#e17055;font-weight:bold;height:20px;}

.clear-anim{
    animation:pop 0.3s ease forwards;
}
@keyframes pop{
    0%{transform:scale(1);}
    50%{transform:scale(1.3);}
    100%{transform:scale(0);}
}
</style>
</head>
<body>

<div class="container">

<div class="menu" id="menu">
<br><br>
<h3>ğŸ¨ ë¸”ë¡ ìƒ‰</h3>
<input type="color" id="blockColorPicker">

<h3>ğŸ§± ë³´ë“œ ë°°ê²½ ìƒ‰</h3>
<input type="color" id="boardColorPicker">
<br><br>
<h3>ğŸ¨ ë¸”ë¡ ìƒ‰</h3>
<input type="color" id="blockColorPicker">

<h3>ğŸ§± ë³´ë“œ ë°°ê²½ ìƒ‰</h3>
<input type="color" id="boardColorPicker">

<h1 style="color:#ff7675;">Block Game</h1>
<p>ìµœê³  ê¸°ë¡: <span id="bestScore">0</span></p>
<br>
<button onclick="startGame()">ê²Œì„ ì‹œì‘</button>
</div>

<div class="game" id="game">
<div class="score">ì ìˆ˜: <span id="score">0</span></div>
<div class="combo" id="combo"></div>
<div class="board" id="board"></div>
<div class="blocks" id="blocks"></div>
<br>
<button onclick="goMenu()">ë©”ë‰´</button>
</div>

</div>

<!-- ğŸ”Š íš¨ê³¼ìŒ -->
<audio id="placeSound" src="place.mp3"></audio>
<audio id="clearSound" src="clear.mp3"></audio>
<audio id="overSound" src="over.mp3"></audio>

<script>
const SIZE=8;
let board=[],score=0,combo=0;
let bestScore=localStorage.getItem("bestScore")||0;
let currentBlocks = [];
let userBlockColor = localStorage.getItem("userBlockColor") || null;
let userBoardColor = localStorage.getItem("userBoardColor") || "#ecf0f1";


document.getElementById("bestScore").textContent=bestScore;

const shapes=[
[[1,1,1]],[[1],[1],[1]],
[[1,1],[1,1]],
[[1,1,1,1]],[[1],[1],[1],[1]],
[[1,0],[1,1]],
[[0,1],[1,1]],
[[1,1,0],[0,1,1]],
[[0,1,1],[1,1,0]],
[[1,1,1],[0,1,0]],
[[0,1,0],[1,1,1]],
[[1,1,1],[1,0,0]],
[[1,1,1],[0,0,1]]
];

const colors=[
"#ff00ff","#00ffff","#39ff14","#ff073a",
"#00ff9f","#faff00","#ff6ec7","#00bfff"
];

let draggingShape=null;
let dragPreview=null;
let failCount = 0;


function startGame(){
    document.getElementById("menu").style.display="none";
    document.getElementById("game").style.display="block";

    // ğŸ”¥ ì˜¤ë””ì˜¤ í™œì„±í™”ìš©
    document.getElementById("placeSound").play().then(()=>{
        document.getElementById("placeSound").pause();
        document.getElementById("placeSound").currentTime=0;
    }).catch(()=>{});
const blockPicker = document.getElementById("blockColorPicker");
const boardPicker = document.getElementById("boardColorPicker");

// ì´ˆê¸°ê°’ ì„¸íŒ…
if(userBlockColor) blockPicker.value = userBlockColor;
boardPicker.value = userBoardColor;

// ë¸”ë¡ ìƒ‰ ë³€ê²½
blockPicker.addEventListener("input", e=>{
    userBlockColor = e.target.value;
    localStorage.setItem("userBlockColor", userBlockColor);
});

// ë³´ë“œ ë°°ê²½ìƒ‰ ë³€ê²½
boardPicker.addEventListener("input", e=>{
    userBoardColor = e.target.value;
    localStorage.setItem("userBoardColor", userBoardColor);
    updateBoard();
});

    init();
}

function goMenu(){
    document.getElementById("game").style.display="none";
    document.getElementById("menu").style.display="block";
}

function init(){
    board=Array(SIZE).fill().map(()=>Array(SIZE).fill(null));
    score=0;combo=0;
    failCount=0;
    updateScore();
    drawBoard();
    generateBlocks();
}

function drawBoard(){
    const boardDiv=document.getElementById("board");
    boardDiv.innerHTML="";
    for(let r=0;r<SIZE;r++){
        for(let c=0;c<SIZE;c++){
            const cell=document.createElement("div");
            cell.className="cell";

            if(board[r][c]){
                cell.style.background = board[r][c];
            }else{
                cell.style.background = userBoardColor;
            }

            cell.dataset.r=r;
            cell.dataset.c=c;
            boardDiv.appendChild(cell);
        }
    }
}


function generateBlocks(){
    const blocksDiv = document.getElementById("blocks");
    blocksDiv.innerHTML = "";

    let validSet = false;

    while(!validSet){
        currentBlocks = [];

        for(let i=0;i<3;i++){
            const shape = JSON.parse(JSON.stringify(
                shapes[Math.floor(Math.random()*shapes.length)]
            ));
            currentBlocks.push(shape);
        }

        for(let shape of currentBlocks){
            for(let r=0;r<SIZE;r++){
                for(let c=0;c<SIZE;c++){
                    if(canPlace(shape,r,c)){
                        validSet = true;
                        break;
                    }
                }
                if(validSet) break;
            }
            if(validSet) break;
        }
    }

    currentBlocks.forEach(shape=>{

        const color = userBlockColor
    ? userBlockColor
    : colors[Math.floor(Math.random()*colors.length)];

        const blockDiv = document.createElement("div");
        blockDiv.className = "block";
        blockDiv.style.gridTemplateColumns = "repeat(" + shape[0].length + ",24px)";
        blockDiv.style.gridTemplateRows = "repeat(" + shape.length + ",24px)";


        shape.forEach(row=>{
            row.forEach(cell=>{
                const mini = document.createElement("div");
                if(cell) mini.style.background = color;
                else mini.style.visibility = "hidden";
                blockDiv.appendChild(mini);
            });
        });

        blockDiv.addEventListener("pointerdown", function(){

            draggingShape = {shape, color, element:blockDiv};

            dragPreview = blockDiv.cloneNode(true);
            dragPreview.style.position = "fixed";
            dragPreview.style.opacity = "0.7";
            dragPreview.style.pointerEvents = "none";

            const boardCell = document.querySelector(".cell");
            if(boardCell){
                const boardSize = boardCell.getBoundingClientRect().width;
                const scale = boardSize / 24;
                dragPreview.style.transform = "scale(" + scale + ")";
                dragPreview.style.transformOrigin = "top left";
            }

            document.body.appendChild(dragPreview);
        });

        blocksDiv.appendChild(blockDiv);

    });

}

document.addEventListener("pointermove",(e)=>{
    if(!dragPreview) return;
    dragPreview.style.left=e.clientX-30+"px";
    dragPreview.style.top=e.clientY-30+"px";
    clearPreview();

    const target=document.elementFromPoint(e.clientX,e.clientY);
    if(target && target.classList.contains("cell")){
        const r=parseInt(target.dataset.r);
        const c=parseInt(target.dataset.c);
        showPreview(r,c);
    }
});

document.addEventListener("pointerup",(e)=>{
    if(!draggingShape) return;
    const target=document.elementFromPoint(e.clientX,e.clientY);
    if(target && target.classList.contains("cell")){
        const r=parseInt(target.dataset.r);
        const c=parseInt(target.dataset.c);
        if(canPlace(draggingShape.shape,r,c)){
            if (navigator.vibrate) navigator.vibrate(50);

            placeShape(draggingShape.shape,r,c,draggingShape.color);
document.getElementById("placeSound").play().catch(()=>{});


// ì‚¬ìš©í•œ ë¸”ë¡ ì œê±°
draggingShape.element.remove();

// ğŸ”¥ currentBlocksì—ì„œë„ ì œê±°
currentBlocks = currentBlocks.filter(s => s !== draggingShape.shape);


// ë¸”ë¡ì´ 0ê°œë©´ ìƒˆë¡œ ìƒì„±
if(document.getElementById("blocks").children.length===0){
    generateBlocks();
}

setTimeout(()=>{
    checkGameOver();
},300);

        }
    }
    draggingShape=null;
    if(dragPreview){dragPreview.remove();dragPreview=null;}
    clearPreview();
});

function canPlace(shape,r,c){
    for(let i=0;i<shape.length;i++){
        for(let j=0;j<shape[0].length;j++){
            if(shape[i][j]){
                if(r+i>=SIZE||c+j>=SIZE||board[r+i][c+j]) return false;
            }
        }
    }
    return true;
}

function showPreview(r,c){
    const valid=canPlace(draggingShape.shape,r,c);
    draggingShape.shape.forEach((row,i)=>{
        row.forEach((cell,j)=>{
            if(cell){
                const rr=r+i,cc=c+j;
                if(rr<SIZE&&cc<SIZE){
                    const index=rr*SIZE+cc;
                    const el=document.getElementById("board").children[index];
                    el.classList.add(valid?"preview-valid":"preview-invalid");
                }
            }
        });
    });
}

function clearPreview(){
    document.querySelectorAll(".preview-valid,.preview-invalid")
    .forEach(c=>c.classList.remove("preview-valid","preview-invalid"));
}

function placeShape(shape,r,c,color){
    shape.forEach((row,i)=>{
        row.forEach((cell,j)=>{
            if(cell) board[r+i][c+j]=color;
        });
    });

    score+=10;
    if (navigator.vibrate) navigator.vibrate(40);

    let cleared = clearLines();

if (cleared > 0) {

    combo++;
    failCount = 0;   // ì„±ê³µí•˜ë©´ ì‹¤íŒ¨ ì´ˆê¸°í™”

    score += cleared * 50 * combo;

    document.getElementById("combo").textContent = `ì½¤ë³´ x${combo}`;
    document.getElementById("clearSound").play().catch(()=>{});

} else {

    failCount++;   // ì‹¤íŒ¨ ì¦ê°€

    if (failCount >= 3) {
        combo = 0;
        failCount = 0;
        document.getElementById("combo").textContent = "";
    }

}

setTimeout(()=>{
    drawBoard();
    updateScore();
},300);




}

function clearLines(){
    let linesToClear=[];

    // ê°€ë¡œ ì²´í¬
    for(let r=0;r<SIZE;r++){
        if(board[r].every(v=>v)){
            for(let c=0;c<SIZE;c++){
                linesToClear.push([r,c]);
            }
        }
    }

    // ì„¸ë¡œ ì²´í¬
    for(let c=0;c<SIZE;c++){
        if(board.every(row=>row[c])){
            for(let r=0;r<SIZE;r++){
                linesToClear.push([r,c]);
            }
        }
    }

    if(linesToClear.length===0) return 0;

    // ğŸ”¥ ë¨¼ì € ê°•ì¡° í‘œì‹œ
    linesToClear.forEach(([r,c])=>{
        const index=r*SIZE+c;
        const el=document.getElementById("board").children[index];
        el.classList.add("clear-highlight");
    });

    // ğŸ”¥ 0.3ì´ˆ í›„ ì‚­ì œ
    setTimeout(()=>{
        linesToClear.forEach(([r,c])=>{
            board[r][c]=null;
        });
    },300);

    return linesToClear.length>0 ? 1 : 0;
}


function animate(r,c){
    const index=r*SIZE+c;
    const el=document.getElementById("board").children[index];
    el.classList.add("clear-anim");
}

function updateScore(){
    document.getElementById("score").textContent=score;
    if(score>bestScore){
        bestScore=score;
        localStorage.setItem("bestScore",bestScore);
        document.getElementById("bestScore").textContent=bestScore;
    }
}

function checkGameOver(){

    if(currentBlocks.length === 0) return false;

    for(let shape of currentBlocks){
        for(let r=0;r<SIZE;r++){
            for(let c=0;c<SIZE;c++){
                if(canPlace(shape,r,c)){
                    return false; // í•˜ë‚˜ë¼ë„ ë†“ì„ ìˆ˜ ìˆìœ¼ë©´ ê³„ì†
                }
            }
        }
    }

    document.getElementById("overSound").play().catch(()=>{});

    setTimeout(()=>{
        alert("ê²Œì„ ì˜¤ë²„!");
        goMenu();
    },200);

    return true;
}

</script>
</body>
</html>
